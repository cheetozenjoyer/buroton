FROM @BASE_IMAGE@ AS base

COPY llvm-0001-Implement-varargs-support-in-clang.patch /tmp
COPY llvm-0002-Add-non-power-of-two-testcase.patch /tmp

RUN wget -q @LLVM_URLBASE@/@LLVM_SOURCE@ \
&& echo '@LLVM_SHA256@ @LLVM_SOURCE@' | sha256sum -c - \
&& tar xf @LLVM_SOURCE@ -C /tmp && rm @LLVM_SOURCE@ \
&& wget -q @MINGW_URLBASE@/@MINGW_SOURCE@ \
&& echo '@MINGW_SHA256@ @MINGW_SOURCE@' | sha256sum -c - \
&& tar xf @MINGW_SOURCE@ -C /tmp && rm @MINGW_SOURCE@ \
&& wget -q @LLVM_MINGW_URLBASE@/@LLVM_MINGW_SOURCE@ \
&& echo '@LLVM_MINGW_SHA256@ @LLVM_MINGW_SOURCE@' | sha256sum -c - \
&& tar xf @LLVM_MINGW_SOURCE@ -C /tmp && rm @LLVM_MINGW_SOURCE@ \
&& ln -s /tmp/llvm-project-llvmorg-@LLVM_VERSION@ /tmp/llvm-mingw-@LLVM_MINGW_VERSION@/llvm-project \
&& ln -s /tmp/mingw-w64-v@MINGW_VERSION@ /tmp/llvm-mingw-@LLVM_MINGW_VERSION@/mingw-w64 \
&& cd /tmp/llvm-project-llvmorg-@LLVM_VERSION@ \
&& patch -p1 < /tmp/llvm-0001-Implement-varargs-support-in-clang.patch \
&& patch -p1 < /tmp/llvm-0002-Add-non-power-of-two-testcase.patch \
&& rm /tmp/llvm-*.patch \
&& cd /tmp/llvm-mingw-@LLVM_MINGW_VERSION@ \
&& ./build-llvm.sh --disable-lldb --disable-clang-tools-extra /opt/llvm-mingw \
&& ./strip-llvm.sh /opt/llvm-mingw \
&& env TOOLCHAIN_TARGET_OSES=mingw32 ./install-wrappers.sh /opt/llvm-mingw \
&& ./build-mingw-w64.sh /opt/llvm-mingw --with-default-msvcrt=ucrt --disable-cfguard \
&& ./build-mingw-w64-tools.sh /opt/llvm-mingw \
&& ./build-compiler-rt.sh /opt/llvm-mingw --disable-cfguard \
&& ./build-libcxx.sh /opt/llvm-mingw --disable-cfguard \
&& ./build-mingw-w64-libraries.sh /opt/llvm-mingw --disable-cfguard \
&& ./build-compiler-rt.sh /opt/llvm-mingw --build-sanitizers \
&& ./build-openmp.sh /opt/llvm-mingw --disable-cfguard \
&& rm -rf /opt/usr/share/doc /opt/usr/share/info /opt/usr/share/man \
&& rm -rf /tmp/llvm-mingw-@LLVM_MINGW_VERSION@
