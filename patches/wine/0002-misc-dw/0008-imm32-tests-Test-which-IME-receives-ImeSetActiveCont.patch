From 647bf3cac54dff6972a915bbe3e7022f4e375ef9 Mon Sep 17 00:00:00 2001
From: Ziia Shi <mkrsym1@gmail.com>
Date: Tue, 3 Feb 2026 18:30:01 +0100
Subject: [PATCH 08/12] imm32/tests: Test which IME receives
 ImeSetActiveContext deactivation call after layout change.

---
 dlls/imm32/tests/imm32.c | 21 +++++++++++++++++++++
 1 file changed, 21 insertions(+)

diff --git a/dlls/imm32/tests/imm32.c b/dlls/imm32/tests/imm32.c
index 5b4e194c367..f65c9640919 100644
--- a/dlls/imm32/tests/imm32.c
+++ b/dlls/imm32/tests/imm32.c
@@ -5582,6 +5582,27 @@ static void test_ImmSetActiveContext(void)
 
     ok_ret( 1, ImmActivateLayout( hkl ) );
     ok_ret( 1, ImmLoadIME( hkl ) );
+    ok_ret( 1, ImmSetActiveContext( hwnd, default_himc, TRUE ) );
+    ok_ret( 1, ImmActivateLayout( default_hkl ) );
+    ok_ret( 1, ImmLoadIME( default_hkl ) );
+    process_messages();
+    memset( ime_calls, 0, sizeof(ime_calls) );
+    ime_call_count = 0;
+    ok_ret( 1, ImmSetActiveContext( hwnd, default_himc, FALSE ) );
+    ok_seq( empty_sequence );
+
+    ok_ret( 1, ImmFreeLayout( hkl ) );
+
+    ok_ret( 1, ImmSetActiveContext( hwnd, default_himc, TRUE ) );
+    ok_ret( 1, ImmActivateLayout( hkl ) );
+    ok_ret( 1, ImmLoadIME( hkl ) );
+    process_messages();
+    memset( ime_calls, 0, sizeof(ime_calls) );
+    ime_call_count = 0;
+    ok_ret( 1, ImmSetActiveContext( hwnd, default_himc, FALSE ) );
+    ok_seq( deactivate_0_seq );
+
+    ok_ret( 1, ImmFreeLayout( default_hkl ) );
     process_messages();
     memset( ime_calls, 0, sizeof(ime_calls) );
     ime_call_count = 0;
-- 
2.53.0

